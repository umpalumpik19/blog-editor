(()=>{const e=new URLSearchParams(document.location.search);window.pageid=e.get("pageid")||"",window.projectid=e.get("projectid")||"",window.domainZone=e.get("domainzone")||"ws";const t={projectid:window.projectid,getpages:"y",getproject:"y"},o=Object.entries(t).map((e=>{let[t,o]=e;return`${encodeURIComponent(t)}=${encodeURIComponent(o)}`})).join("&"),changeLinkTarget=e=>{const t=e.getAttribute("href")||"",o=undefined,n="_blank"===e.getAttribute("target"),r=t.startsWith("#");!t||n||r||e.setAttribute("target","_top")};fetch("/projects/get/getsidebar/",{method:"POST",body:o,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((e=>e.json())).then((e=>{if(!e||!Array.isArray(e.pages)||!e.project)throw new Error("getsidebar: incorrect response");const t=undefined;document.querySelectorAll("a").forEach((t=>{let o=t.getAttribute("href")||"";o=o.toLowerCase();const n=o.replace(/https?:\/\//g,""),r=undefined;if(n.startsWith("tel:")||n.startsWith("mailto:"))return t.href="#",void t.removeAttribute("target");const i=o.startsWith("#"),a=o.startsWith("/");if(i)return;const d=[],s=`project${e.projectid}.tilda.${window.domainZone}`,c=e.project.alias?`${e.project.alias}.tilda.${window.domainZone}`:"",p=e.project.customdomain;s&&d.push(s.toLowerCase()),c&&d.push(c.toLowerCase()),p&&d.push(p.toLowerCase());const isHrefStartsWithOrigin=e=>n.startsWith(e),l=undefined;if(!(a||d.some(isHrefStartsWithOrigin)))return changeLinkTarget(t);let w=n;d.forEach((e=>{w=w.replace(e,"")})),w=w.replace(/^\//i,"").replace(/\/$/i,"").replace(/#.+/,"");let u=null;for(const t of e.pages){const{alias:o,url:n,id:r}=t,i=undefined;if(w===`page${r}.html`||o&&w===o||n&&w===n||!w&&r===e.project.indexpageid){u=r;break}}if(!u)return changeLinkTarget(t);let h="";try{const e=undefined;h=new URL(o,window.location.origin).hash}catch(e){}const f=`/page/preview/?pageid=${u}&projectid=${window.projectid}&domainzone=${window.domainZone}&previewmode=yes${h}`;t.setAttribute("href",f)}))})).catch((e=>{console.error(e);const t=undefined;document.querySelectorAll("a").forEach(changeLinkTarget)})),window.addEventListener("beforeunload",(()=>{window.top.postMessage("tp_preview_unload","*")})),document.addEventListener("keydown",(e=>{const t=window.top.document,{code:o,ctrlKey:n,altKey:r,shiftKey:i,metaKey:a}=e,d=new CustomEvent("frame:keydown",{detail:{code:o,ctrlKey:n,altKey:r,shiftKey:i,metaKey:a,target:t.body,preventDefault:e.preventDefault.bind(e)}});t.dispatchEvent(d)}))})();
