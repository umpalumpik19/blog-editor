(()=>{"use strict";class t{constructor(e,o){var n=this;if(!(e instanceof HTMLSelectElement))throw new TypeError("select must be a HTMLSelectElement");o="[object Object]"===Object.prototype.toString.call(o)?o:{},this.config={theme:["light","dark"].includes(o.theme)?o.theme:"light",height:o.height&&!isNaN(o.height)?o.height:40,iconSize:t.getIconSize(o.iconSize),minWidth:o.minWidth||null,fontSize:o.fontSize&&!isNaN(o.fontSize)?o.fontSize:null,customClassName:o.customClassName||null,maxHeight:o.maxHeight&&!isNaN(o.maxHeight)?o.maxHeight:300,maxWidth:o.maxWidth||null},this.id=t.getId(),this.select=e,this.disabled=this.select.disabled,this.options=this.getOptions(),this.isDropdownOpened=!1,this.dropdownHeight=this.config.maxHeight,this.touchStartPos=-1,this.openDropdown=this.openDropdown.bind(this),this.handleDocClick=this.handleDocClick.bind(this),this.handleDocKeyDown=this.handleDocKeyDown.bind(this),this.handleOptionClick=this.handleOptionClick.bind(this),this.handleSelectChange=this.handleSelectChange.bind(this),this.preventScroll=this.preventScroll.bind(this),this.handleDropdownScroll=this.handleDropdownScroll.bind(this),this.updateDropdownPosition=this.updateDropdownPosition.bind(this),this.handleOptionFocus=this.handleOptionFocus.bind(this);const s=this.performDropdownScroll.bind(this);let i=null;const d=()=>this.isDropdownOpened;this.scrollShift={value:0,setValue:function(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];d()&&(e&&i&&(window.clearInterval(i),i=null),n.value=e?t:n.value+t,Math.abs(n.value)<.5&&(n.value=0),Math.abs(n.value)>5&&!i&&(i=window.setInterval((()=>{const t=5*Math.sign(n.value);s(t),n.value=(Math.abs(n.value)-5)*Math.sign(n.value),Math.abs(n.value)<=5&&(n.value=0,i&&(window.clearInterval(i),i=null))}),0)),Math.abs(n.value)<=5&&(s(n.value),n.value=0,i&&(window.clearInterval(i),i=null)))}},this.init()}init(){const{theme:t,height:e,minWidth:o,customClassName:n}=this.config,s=document.createElement("button");s.classList.add("tsel"),s.type="button",s.role="combobox",s.ariaExpanded=!1,s.ariaControls=this.id,s.setAttribute("aria-owns",this.id),"dark"===t&&s.classList.add("tsel_dark"),s.style.minHeight=`${e}px`,this.disabled&&s.classList.add("tsel_disabled"),n&&s.classList.add(n),this.select.after(s),s.append(this.select),this.select.style.display="none";const i=document.createElement("div");i.classList.add("tsel-dropdown","tsel-dropdown_hidden"),"dark"===t&&i.classList.add("tsel-dropdown_dark"),o&&(i.style.minWidth=o),i.role="listbox",i.id=this.id;const d=this.select.getAttribute("data-hint");if(d){const t=document.createElement("div");t.classList.add("tsel-dropdown__hint"),t.innerHTML=d,i.append(t)}this.createOptionsElements(),i.prepend(...this.options.map((t=>t.element)));const l=document.createElement("div");l.classList.add("tsel-dropdown__scroll-top"),this.dropdownScrollTopIcon=l;const r=document.createElement("div");r.classList.add("tsel-dropdown__scroll-bottom"),this.dropdownScrollBottomIcon=r;const a=document.createElement("div");a.classList.add("tsel__selected-option"),s.append(a);const h=document.createElement("div");h.classList.add("tsel__noaction"),this.container=s,this.dropdown=i,this.selectedElement=a,this.noaction=h,this.setSelectedElement(),this.setHandlers()}destroy(){this.closeDropdown(),this.container.removeEventListener("click",this.openDropdown),this.select.removeEventListener("change",this.handleSelectChange),this.removeOptionsHandlers(),this.container.before(this.select),this.container.remove()}update(){this.isDropdownOpened&&this.closeDropdown(),this.removeOptionsHandlers(),this.options.forEach((t=>{let{element:e}=t;return e.remove()})),this.options=this.getOptions(),this.createOptionsElements(),this.setOptionsHandlers(),this.dropdown.prepend(...this.options.map((t=>t.element))),this.selectedElement.innerHTML="",this.setSelectedElement(),this.disabled=this.select.disabled,this.container.classList.toggle("tsel_disabled",this.disabled)}getOptions(){return Array.from(this.select.querySelectorAll("option, optgroup")).map((t=>{const e="OPTGROUP"===t.tagName,o=t.parentElement&&"OPTGROUP"===t.parentElement.tagName;return{type:e?"group":"option",value:e?void 0:t.value,img:e?void 0:t.getAttribute("data-img"),darkImg:e?void 0:t.getAttribute("data-img-dark"),label:e?t.label?.replace(/\n/g,"").trim():t.textContent.replace(/\n/g,"").trim(),disabled:e?void 0:t.disabled,selected:e?void 0:t.selected,fontFamily:t.getAttribute("data-font-family"),fontWeight:t.getAttribute("data-font-weight"),noInvert:e?void 0:t.hasAttribute("data-no-invert"),isInGroup:o}}))}createOptionsElements(){const t=this.options.some((t=>t.img)),{theme:e,iconSize:o}=this.config;this.options.forEach((n=>{if("group"===n.type){const t=document.createElement("div");return t.classList.add("tsel-dropdown__group"),n.fontFamily&&(t.style.fontFamily=`${n.fontFamily}, tfutura, Arial, sans-serif`),n.fontWeight&&(t.style.fontWeight=n.fontWeight),n.label&&(t.textContent=n.label),void(n.element=t)}const s=document.createElement("button");if(s.type="button",s.classList.add("tsel-dropdown__option"),n.selected&&(s.classList.add("tsel-dropdown__option_selected"),s.ariaSelected=!0),n.disabled&&(s.classList.add("tsel-dropdown__option_disabled"),s.disabled=!0),n.isInGroup&&s.classList.add("tsel-dropdown__option_group"),n.img||t){const t=document.createElement("div");t.classList.add("tsel-dropdown__option-image"),n.noInvert&&t.classList.add("tsel-dropdown__option-image_no-invert"),t.style.width=`${o[0]}px`,t.style.height=`${o[1]}px`,n.img?t.style.backgroundImage=`url('${"dark"===e&&n.darkImg?n.darkImg:n.img}')`:t.classList.add("tsel-dropdown__option-image_placeholder"),s.append(t)}if(n.label){const t=document.createElement("div");t.classList.add("tsel-dropdown__option-label");const e=document.createElement("span");e.classList.add("tsel-dropdown__option-span"),e.textContent=n.label,n.fontFamily&&(e.style.fontFamily=`${n.fontFamily}, tfutura, Arial, sans-serif`),n.fontWeight&&(e.style.fontWeight=n.fontWeight),t.append(e),s.append(t)}n.element=s}))}setHandlers(){this.container.addEventListener("click",this.openDropdown),this.select.addEventListener("change",this.handleSelectChange),this.setOptionsHandlers()}setOptionsHandlers(){this.options.forEach((t=>{const{element:e}=t;e.addEventListener("mouseenter",this.handleOptionHover),e.addEventListener("mouseleave",this.handleOptionLeave),e.addEventListener("click",this.handleOptionClick),e.addEventListener("focus",this.handleOptionFocus),t.disabled||e.addEventListener("mousemove",this.handleOptionMousemove)}))}removeOptionsHandlers(){this.options.forEach((t=>{const{element:e}=t;e.removeEventListener("mouseenter",this.handleOptionHover),e.removeEventListener("mouseleave",this.handleOptionLeave),e.removeEventListener("click",this.handleOptionClick),e.removeEventListener("focus",this.handleOptionFocus),e.removeEventListener("mousemove",this.handleOptionMousemove)}))}setSelectedElement(){const{fontSize:t}=this.config,e=this.options.find((t=>t.selected));if(!e)return;const o=e.element.cloneNode(!0),n=o.querySelector(".tsel-dropdown__option-span");n&&n.removeAttribute("style");const s=o.querySelector(".tsel-dropdown__option-label");s&&t&&(s.style.fontSize=`${t}px`);const i=Array.from(o.children);this.selectedElement.innerHTML="",this.selectedElement.append(...i)}openDropdown(){if(this.disabled||this.isDropdownOpened||!this.options.length)return;const{maxHeight:t,maxWidth:e}=this.config,o=this.container.getBoundingClientRect(),n=document.documentElement.clientHeight;this.dropdownHeight=Math.min(t,n-10),this.dropdown.style.width=e?`min(${o.width}px, ${e})`:`${o.width}px`,this.dropdown.style.maxHeight=`${this.dropdownHeight}px`,this.dropdown.style.left=`${Math.max(5,o.left)}px`,document.body.append(this.noaction,this.dropdown);const s=this.options.find((t=>t.selected))?.element||this.options[0].element;s.focus({preventScroll:!0});const i=Math.min(this.dropdown.clientHeight,t),d=s.offsetTop+s.clientHeight/2,l=this.dropdown.clientHeight/2,r=d-l,a=this.dropdown.scrollHeight-this.dropdown.clientHeight;let h=0;r>a&&(h=r-a),r<0&&(h=r);const c=o.top+o.height/2,p=Math.min(n-10-i,Math.max(5,c-l-h)),m=Math.max(0,5-(c-l-h));this.dropdown.style.top=`${p}px`,this.dropdownHeight=Math.max(i,Math.min(t-m,n-p-10)),this.dropdown.style.maxHeight=`${this.dropdownHeight}px`,this.dropdown.scrollTop=r+m,document.addEventListener("click",this.handleDocClick),document.addEventListener("keydown",this.handleDocKeyDown,{capture:!0,passive:!1}),document.addEventListener("touchstart",this.preventScroll,{passive:!1}),document.addEventListener("touchmove",this.preventScroll,{passive:!1}),window.addEventListener("resize",this.updateDropdownPosition),document.addEventListener("wheel",this.preventScroll,{capture:!0,passive:!1}),this.dropdown.addEventListener("wheel",this.handleDropdownScroll,{passive:!1}),this.isDropdownOpened=!0,this.container.ariaExpanded=!0,this.dropdown.classList.remove("tsel-dropdown_hidden"),this.updateDropdownScrollIcons()}closeDropdown(){this.dropdown.classList.add("tsel-dropdown_hidden"),window.setTimeout((()=>{this.scrollShift.setValue(0,!0),this.dropdown.scrollTop=0,this.dropdownScrollBottomIcon.remove(),this.dropdownScrollTopIcon.remove(),this.dropdown.remove(),this.noaction.remove(),document.removeEventListener("click",this.handleDocClick),document.removeEventListener("keydown",this.handleDocKeyDown,{capture:!0,passive:!1}),document.removeEventListener("touchstart",this.preventScroll,{passive:!1}),document.removeEventListener("touchmove",this.preventScroll,{passive:!1}),window.removeEventListener("resize",this.updateDropdownPosition),document.removeEventListener("wheel",this.preventScroll,{capture:!0,passive:!1}),this.dropdown.removeEventListener("wheel",this.handleDropdownScroll,{passive:!1}),this.dropdown.querySelectorAll(".tsel-dropdown__option-span").forEach((t=>{t.style.removeProperty("transition-duration"),t.style.removeProperty("transform")})),this.isDropdownOpened=!1,this.container.focus(),this.container.ariaExpanded=!1}),100)}handleDocClick(t){this.container.contains(t.target)||this.dropdown.contains(t.target)||this.closeDropdown()}handleDocKeyDown(t){if("Escape"===t.key&&(t.preventDefault(),t.stopPropagation(),this.closeDropdown()),["ArrowUp","ArrowDown","PageUp","PageDown"].includes(t.key)&&(t.preventDefault(),t.stopPropagation(),["ArrowUp","ArrowDown"].includes(t.key))){const e=this.options.findIndex((t=>t.element===document.activeElement));if("ArrowUp"===t.key){const t=Math.max(0,e-1),o=this.options.findLast(((e,o)=>!e.disabled&&o<=t));o&&o.element.focus({preventScroll:!0})}else{const t=Math.min(this.options.length-1,e+1),o=this.options.find(((e,o)=>!e.disabled&&o>=t));o&&o.element.focus({preventScroll:!0})}}"Tab"===t.key&&(t.preventDefault(),t.stopPropagation());const e=t.key.toLowerCase();if(/^[a-zа-я]$/.test(e)&&!t.altKey&&!t.ctrlKey&&!t.metaKey&&!t.shiftKey){t.preventDefault(),t.stopPropagation();const o=this.options.find((t=>t.label.toLowerCase().startsWith(e)));o&&o.element.focus({preventScroll:!0})}}preventScroll(t){if(this.dropdown.contains(t.target)){const e=this.dropdown.scrollHeight,o=this.dropdown.scrollTop,n=this.dropdown.clientHeight,s=Math.abs(o-(e-n))<1;if((t.deltaY<0&&!o||t.deltaY>=0&&s||["touchstart","touchmove"].includes(t.type))&&("touchstart"!==t.type&&t.preventDefault(),"touchstart"===t.type&&(this.touchStartPos=t.touches[0]?.clientY||-1),"touchmove"===t.type&&this.touchStartPos>-1)){const e=t.changedTouches[0]?.clientY||-1,o=this.touchStartPos;this.touchStartPos=e,e>-1&&this.dropdown.dispatchEvent(new WheelEvent("wheel",{deltaY:o-e}))}}else"touchstart"!==t.type&&(t.preventDefault(),t.stopPropagation())}handleOptionHover(){const t=this.querySelector(".tsel-dropdown__option-span");if(!t)return;let e=t.parentElement.offsetWidth-t.offsetWidth;if(e=Math.min(e,0),e){const o=60,n=Math.abs(e)/o;t.style.setProperty("transition-duration",`${n}s`),t.style.setProperty("transform",`translateX(${e}px)`)}}handleOptionLeave(){const t=this.querySelector(".tsel-dropdown__option-span");t&&(t.style.removeProperty("transition-duration"),t.style.removeProperty("transform"))}handleOptionClick(t){const e=t.target.closest(".tsel-dropdown__option"),o=this.options.find((t=>t.element===e));o.disabled||(o.selected||(this.select.value=o.value,window.setTimeout((()=>{this.select.dispatchEvent(new Event("change"))}),100)),this.closeDropdown())}handleOptionMousemove(){const t=this;document.activeElement!==t&&t.focus({preventScroll:!0})}handleOptionFocus(t){const e=t.target.getBoundingClientRect(),o=this.dropdown.getBoundingClientRect(),n=e.top-o.top,s=n+e.height-o.height,i=n<0?n-10:s>0?s+10:0;i&&this.scrollShift.setValue(i,!0)}handleSelectChange(){const t=this.select.value,e=this.options.find((e=>e.value===t));if(!e)return;const o=this.options.find((t=>t.selected));o&&(o.selected=!1,o.element.classList.remove("tsel-dropdown__option_selected"),o.element.ariaSelected=!1),e.selected=!0,e.element.classList.add("tsel-dropdown__option_selected"),e.element.ariaSelected=!0,this.setSelectedElement()}handleDropdownScroll(t){t.preventDefault();const{deltaY:e}=t;this.scrollShift.setValue(e,Math.sign(this.scrollShift.value)!==Math.sign(e))}performDropdownScroll(t){if(!(t=Math.ceil(Math.abs(t))*Math.sign(t)))return;const e=document.documentElement.clientHeight,o=this.dropdown.offsetTop,n=this.dropdown.scrollTop,s=this.dropdown.scrollHeight,i=this.dropdown.clientHeight,d=Math.abs(n-(s-i))<1;if(this.dropdownHeight===e-10||5===o&&t>0||t>0&&d||t<0&&0===n)return this.dropdown.scrollTop=n+t,void this.updateDropdownScrollIcons();if(o>5&&t>0){const e=Math.max(5,o-Math.abs(t));this.dropdown.style.top=`${e}px`}t<0&&(this.dropdown.scrollTop=n+t),this.dropdownHeight+=Math.abs(t),this.dropdownHeight=Math.min(this.dropdownHeight,e-this.dropdown.offsetTop-5),this.dropdown.style.maxHeight=`${this.dropdownHeight}px`,this.updateDropdownScrollIcons()}updateDropdownPosition(){const{maxWidth:t}=this.config;if(!this.isDropdownOpened)return;const e=this.container.getBoundingClientRect();this.dropdown.style.width=t?`min(${e.width}px, ${t})`:`${e.width}px`;this.dropdown.style.left=`${Math.max(5,e.left)}px`}updateDropdownScrollIcons(){const{scrollTop:t,clientHeight:e,scrollHeight:o}=this.dropdown,n=o-e;t>0?this.dropdown.prepend(this.dropdownScrollTopIcon):this.dropdownScrollTopIcon.remove(),o!==e&&Math.abs(t-n)>=1?this.dropdown.append(this.dropdownScrollBottomIcon):this.dropdownScrollBottomIcon.remove()}static getId(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let e="tsel_";for(let o=0;o<8;o++){const o=Math.floor(62*Math.random());e+=t.charAt(o)}return e}static getIconSize(t){const e=Array.isArray(t)?t:[t];return e.length||e.push(18,18),1===e.length&&e.push(e[0]),e.splice(2,e.length),e.every((t=>t&&!isNaN(t)))?e:[18,18]}}window.TSelectbox=t})();